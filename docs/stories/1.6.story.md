# Story 1.6: Peer Update Subscriptions

## Status

Done

## Story

**As an** agent developer,
**I want** to subscribe to updates when peers change their ILP info,
**so that** my routing table stays current.

## Acceptance Criteria

1. `subscribeToPeerUpdates(pubkey: string, callback: (pubkey, info) => void): Promise<Subscription>` method added
2. Subscription receives callbacks when kind:10032 events are published by followed pubkeys
3. `Subscription` object has `unsubscribe()` method to stop receiving updates
4. Callback receives parsed `IlpPeerInfo` (not raw events)
5. Unit tests verify subscription lifecycle and callback invocation

## Tasks / Subtasks

- [x] Task 1: Define Subscription type (AC: 3)
  - [x] Create `Subscription` interface in `packages/core/src/types.ts` with `unsubscribe(): void` method
  - [x] Export `Subscription` type from package index

- [x] Task 2: Add subscribeToPeerUpdates method signature (AC: 1)
  - [x] Add `subscribeToPeerUpdates(pubkey: string, callback: (pubkey: string, info: IlpPeerInfo) => void): Promise<Subscription>` method to `NostrPeerDiscovery`
  - [x] Method is async because it needs to fetch follow list before setting up subscription
  - [x] Validate pubkey format (reuse existing PUBKEY_REGEX validation)
  - [x] Throw `PeerDiscoveryError` for invalid pubkey

- [x] Task 3: Implement subscription setup with follow list retrieval (AC: 2, 4)
  - [x] Make `subscribeToPeerUpdates` an async method that returns `Promise<Subscription>`
  - [x] Call `getFollows(pubkey)` to get list of followed pubkeys at subscription time
  - [x] If follow list is empty, return a no-op Subscription (unsubscribe does nothing, no callbacks ever fire)
  - [x] Note: Follow list is queried once at subscription time, not monitored for changes
  - [x] Create filter for kind:10032 with authors array containing followed pubkeys
  - [x] Call `pool.subscribeMany(relayUrls, filter, { onevent: ... })` to subscribe
  - [x] In `onevent` callback: parse event with `parseIlpPeerInfo()`
  - [x] If parse succeeds, call user callback with `(event.pubkey, parsedInfo)`
  - [x] If parse fails, silently ignore (consistent with discoverPeers behavior)
  - [x] Note: `oneose` callback can be ignored - we don't need to distinguish historical vs live events

- [x] Task 4: Implement Subscription object with unsubscribe (AC: 3)
  - [x] Store the `SubCloser` returned by `pool.subscribeMany()`
  - [x] Create Subscription object that wraps SubCloser
  - [x] `unsubscribe()` method calls `subCloser.close()`
  - [x] Track subscription state to prevent double-unsubscribe
  - [x] For empty follow list case, return no-op Subscription with empty unsubscribe

- [x] Task 5: Handle replaceable event semantics for updates (AC: 2, 4)
  - [x] Create a per-subscription `Map<string, number>` to track latest `created_at` per pubkey
  - [x] This map is scoped to each subscription instance (not shared across subscriptions)
  - [x] Only invoke callback if new event has higher `created_at` than previously seen
  - [x] This prevents callbacks for stale events that arrive out of order

- [x] Task 6: Update module exports (AC: 1)
  - [x] Export `Subscription` type from `packages/core/src/index.ts`
  - [x] Verify `subscribeToPeerUpdates` is accessible via class instance

- [x] Task 7: Write unit tests for subscription creation (AC: 1, 5)
  - [x] Test subscribeToPeerUpdates returns a Subscription object
  - [x] Test Subscription object has unsubscribe method
  - [x] Test throws PeerDiscoveryError for invalid pubkey
  - [x] Test empty follow list returns valid no-op Subscription

- [x] Task 8: Write unit tests for callback invocation (AC: 2, 4, 5)
  - [x] Test callback is invoked when kind:10032 event is received
  - [x] Test callback receives pubkey and parsed IlpPeerInfo (not raw event)
  - [x] Test callback is not invoked for malformed events (silent skip)
  - [x] Test multiple callbacks for different peers work correctly
  - [x] Test empty follow list subscription never invokes callback

- [x] Task 9: Write unit tests for unsubscribe lifecycle (AC: 3, 5)
  - [x] Test unsubscribe() stops receiving callbacks
  - [x] Test unsubscribe() calls SubCloser.close()
  - [x] Test double unsubscribe is safe (no-op or handled gracefully)
  - [x] Test empty follow list subscription unsubscribe is safe no-op

- [x] Task 10: Write unit tests for replaceable event handling (AC: 2, 5)
  - [x] Test newer event triggers callback
  - [x] Test older/stale event does NOT trigger callback
  - [x] Test events for different peers are tracked independently

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.5.story.md#dev-agent-record]

- `NostrPeerDiscovery` class exists in `packages/core/src/discovery/NostrPeerDiscovery.ts`
- `discoverPeers(pubkey)` method is complete and uses `parseIlpPeerInfo()` for parsing
- `getFollows(pubkey)` method returns `Promise<string[]>` of followed pubkeys
- `PeerDiscoveryError` exists in `packages/core/src/errors.ts`
- Uses `pool.querySync(relayUrls, filter)` pattern for one-time queries
- Pubkey validation regex: `/^[0-9a-f]{64}$/`
- 75 tests currently pass in core package
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled
- Test helpers cast through `unknown` for `VerifiedEvent` type: `as unknown as VerifiedEvent`

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to modify for this story:
```
packages/core/src/
├── types.ts                            # Add Subscription interface (modify)
├── index.ts                            # Export Subscription type (modify)
├── discovery/
│   ├── NostrPeerDiscovery.ts           # Add subscribeToPeerUpdates method (modify)
│   └── NostrPeerDiscovery.test.ts      # Add new tests (modify)
```

### Data Models
[Source: docs/architecture/4-data-models.md]

**IlpPeerInfo (kind:10032):**
- `ilpAddress`: string - ILP address of the peer's connector
- `btpEndpoint`: string - BTP WebSocket endpoint URL
- `settlementEngine`: string | undefined - Settlement engine identifier
- `assetCode`: string - Asset code (e.g., "USD", "XRP")
- `assetScale`: number - Asset scale (decimal places)

**Subscription interface (to be created):**
```typescript
export interface Subscription {
  /** Stops receiving updates and closes the underlying relay subscription */
  unsubscribe(): void;
}
```

### nostr-tools SimplePool Subscription API
[Source: node_modules/nostr-tools, docs/architecture/3-tech-stack.md]

**SimplePool.subscribeMany() for real-time subscriptions:**
```typescript
import { SimplePool } from 'nostr-tools/pool';
import type { SubCloser, SubscribeManyParams } from 'nostr-tools/pool';
import type { Filter } from 'nostr-tools/filter';
import type { Event } from 'nostr-tools/core';

const filter: Filter = {
  kinds: [ILP_PEER_INFO_KIND],
  authors: followedPubkeys,
};

const params: SubscribeManyParams = {
  onevent: (event: Event) => {
    // Handle incoming event
  },
  oneose: () => {
    // End of stored events - now receiving live updates
  },
};

const subCloser: SubCloser = pool.subscribeMany(relayUrls, filter, params);

// To stop subscription:
subCloser.close();
```

**SubCloser type:**
```typescript
type SubCloser = {
  close: (reason?: string) => void;
};
```

**Type Export Note:** The `SubCloser` and `SubscribeManyParams` types may not be publicly exported from nostr-tools. During implementation, verify these types exist in `node_modules/nostr-tools/lib/types/pool.d.ts`. If not exported, use inline type definitions or cast through `unknown`:
```typescript
// If types aren't exported, define inline or use unknown casting
const subCloser = pool.subscribeMany(relayUrls, filter, {
  onevent: (event) => { /* ... */ },
}) as { close: () => void };
```

**Key insight:** Use `subscribeMany` instead of `querySync` for continuous subscriptions. The subscription will first receive any existing events (followed by `oneose`), then continue receiving new events as they're published.

### Event Parsing
[Source: packages/core/src/events/parsers.ts, docs/stories/1.3.story.md]

The `parseIlpPeerInfo` function is already implemented:
```typescript
import { parseIlpPeerInfo } from '../events/index.js';

try {
  const info = parseIlpPeerInfo(event);
  // Successfully parsed - invoke callback
} catch (error) {
  // InvalidEventError - silently skip
}
```

### Replaceable Event Tracking
[Source: NIP-01, docs/architecture/4-data-models.md]

kind:10032 is a replaceable event (kind 10000-19999). For subscriptions, we need to track timestamps to avoid invoking callbacks for stale events.

**Important:** The timestamp map must be scoped per-subscription, not shared across subscriptions. Each call to `subscribeToPeerUpdates` creates its own tracking state.

```typescript
// Inside subscribeToPeerUpdates - create per-subscription tracking
const peerTimestamps = new Map<string, number>();

// In onevent callback (closure captures the per-subscription map):
const lastSeen = peerTimestamps.get(event.pubkey) ?? 0;
if (event.created_at > lastSeen) {
  peerTimestamps.set(event.pubkey, event.created_at);
  // Now safe to invoke user callback
}
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

**For this story:**
- Invalid pubkey → throw `PeerDiscoveryError` (consistent with existing methods)
- Relay failures → `subscribeMany` handles internally, reconnects automatically
- Parse failures → Silently skip (don't invoke callback)
- Empty follow list → Return valid Subscription that never fires callbacks

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Method | camelCase | `subscribeToPeerUpdates` |
| Interface | PascalCase | `Subscription` |
| Private field | camelCase | `peerTimestamps` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Use nostr-tools types - don't redefine event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File:** `packages/core/src/discovery/NostrPeerDiscovery.test.ts` (add to existing)

**Mocking subscribeMany:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import type { SimplePool } from 'nostr-tools/pool';
import type { SubscribeManyParams, SubCloser } from 'nostr-tools/pool';

const mockSubCloser: SubCloser = {
  close: vi.fn(),
};

const mockPool = {
  querySync: vi.fn(),
  subscribeMany: vi.fn().mockReturnValue(mockSubCloser),
} as unknown as SimplePool;

// Simulate receiving an event in test:
let capturedOnevent: ((event: Event) => void) | undefined;
vi.mocked(mockPool.subscribeMany).mockImplementation(
  (_relays, _filter, params: SubscribeManyParams) => {
    capturedOnevent = params.onevent;
    return mockSubCloser;
  }
);

// Later, trigger the callback:
capturedOnevent?.(mockEvent);
```

**Test helper for kind:10032 events (reuse from Story 1.5):**
```typescript
function createIlpPeerInfoEvent(
  pubkey: string,
  info: Partial<IlpPeerInfo> = {},
  created_at = Math.floor(Date.now() / 1000)
): VerifiedEvent {
  return {
    id: `mock-id-${pubkey.slice(0, 8)}`,
    pubkey,
    kind: ILP_PEER_INFO_KIND,
    content: JSON.stringify({
      ilpAddress: info.ilpAddress ?? 'g.test.peer',
      btpEndpoint: info.btpEndpoint ?? 'wss://btp.test',
      assetCode: info.assetCode ?? 'USD',
      assetScale: info.assetScale ?? 6,
    }),
    tags: [],
    created_at,
    sig: 'mock-sig',
  } as unknown as VerifiedEvent;
}
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all SimplePool calls (querySync for getFollows, subscribeMany for subscription)
- Test both success and error paths
- Cover replaceable event timestamp tracking
- >80% coverage for new method

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

| File | Action | Description |
|------|--------|-------------|
| packages/core/src/types.ts | Modified | Added `Subscription` interface |
| packages/core/src/index.ts | Modified | Added `Subscription` to exports |
| packages/core/src/discovery/NostrPeerDiscovery.ts | Modified | Added `subscribeToPeerUpdates` method |
| packages/core/src/discovery/NostrPeerDiscovery.test.ts | Modified | Added 16 new tests for subscription functionality |

### Debug Log References

**QA Fix Session (2026-02-06):**
- `pnpm lint` → 0 problems
- `pnpm test` → 91 tests pass (6 test files)

### Completion Notes

- All 10 tasks completed successfully
- 91 tests pass (75 existing + 16 new)
- Linting passes
- `Subscription` interface created with `unsubscribe()` method
- `subscribeToPeerUpdates` method implemented with:
  - Pubkey validation (reuses PUBKEY_REGEX)
  - Empty follow list returns no-op Subscription
  - Per-subscription timestamp tracking for replaceable events
  - Silent skip for malformed events
  - Double-unsubscribe protection

**QA Fix Applied (2026-02-06):**
- Fixed TypeScript error TS2345 on line 190: changed `[filter]` to `filter`
- The `subscribeMany` method expects a single `Filter` object, not an array

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is well-structured and follows established patterns from previous stories. The `subscribeToPeerUpdates` method is cleanly implemented with:
- Proper pubkey validation (reusing PUBKEY_REGEX)
- Per-subscription timestamp tracking for replaceable events
- Double-unsubscribe protection
- Silent skip for malformed events
- Graceful empty follow list handling

However, there is a **critical TypeScript compilation error** that must be fixed before this story can pass.

### Refactoring Performed

None - blocked by TypeScript compilation error.

### Compliance Check

- Coding Standards: ✗ TypeScript compilation fails (strict mode)
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ 16 new tests, 91 total passing (>80% coverage)
- All ACs Met: ✓ Functionally complete (tests verify behavior)

### Improvements Checklist

- [ ] **MUST FIX**: Line 190 in `NostrPeerDiscovery.ts` - change `[filter]` to `filter` (single Filter, not array)
- [x] Subscription interface properly defined with JSDoc
- [x] Exports added to package index
- [x] Test helpers use correct `as unknown as VerifiedEvent` casting pattern
- [x] Edge cases covered (empty follows, malformed events, stale events)

### Security Review

No security concerns. Implementation follows established patterns:
- Pubkey validation before relay queries
- No trust of unverified data
- Proper error propagation

### Performance Considerations

No concerns. The implementation uses the same efficient patterns as `discoverPeers`:
- Single batch query for follow list
- Event-driven subscription (no polling)
- Per-subscription state maps are lightweight

### Files Modified During Review

None - TypeScript error needs dev fix.

### Gate Status

Gate: FAIL → docs/qa/gates/1.6-peer-update-subscriptions.yml

### Recommended Status

✗ Changes Required - See unchecked items above
(Story owner decides final status)

**Blocking Issue:** TypeScript compilation fails with error TS2345 on line 190. The `subscribeMany` function expects a single `Filter` object but receives `[filter]` (an array). This must be fixed before the story can proceed.

---

### Review Date: 2026-02-06 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation.** The previous TypeScript error has been fixed. The `subscribeToPeerUpdates` method follows the established patterns from previous stories:

- **Well-structured async flow**: Fetches follow list, then sets up subscription
- **Per-subscription state isolation**: Each subscription has its own timestamp tracking map
- **Proper closure usage**: The `isUnsubscribed` flag and `peerTimestamps` map are correctly scoped
- **Defensive programming**: Double-unsubscribe is safely handled with the `isUnsubscribed` flag
- **Consistent error handling**: Uses `PeerDiscoveryError` like other methods
- **Silent failure for malformed events**: Consistent with `discoverPeers` behavior

### Refactoring Performed

None required. The implementation is clean and follows coding standards.

### Compliance Check

- Coding Standards: ✓ No `any` types, proper naming conventions, strict TypeScript
- Project Structure: ✓ Files in correct locations (`types.ts`, `NostrPeerDiscovery.ts`)
- Testing Strategy: ✓ 16 new tests (42 total for discovery), 91 tests pass
- All ACs Met: ✓ All 5 acceptance criteria verified

### Acceptance Criteria Traceability

| AC | Requirement | Test(s) |
|----|-------------|---------|
| 1 | `subscribeToPeerUpdates` method signature | `returns a Subscription object`, `throws PeerDiscoveryError for invalid pubkey` |
| 2 | Callbacks on kind:10032 events | `callback is invoked when kind:10032 event is received`, `multiple callbacks for different peers work correctly` |
| 3 | `Subscription.unsubscribe()` method | `Subscription object has unsubscribe method`, `unsubscribe() calls SubCloser.close()`, `double unsubscribe is safe` |
| 4 | Callback receives parsed `IlpPeerInfo` | `callback receives pubkey and parsed IlpPeerInfo (not raw event)` |
| 5 | Unit tests for subscription lifecycle | All 16 new tests in `subscribeToPeerUpdates` describe block |

### Improvements Checklist

- [x] TypeScript error fixed (subscribeMany filter parameter)
- [x] Subscription interface properly defined with JSDoc
- [x] Exports added to package index
- [x] Test helpers use correct `as unknown as VerifiedEvent` casting pattern
- [x] Edge cases covered (empty follows, malformed events, stale events)
- [x] Replaceable event semantics correctly implemented

### Security Review

No security concerns. Implementation follows established patterns:
- Pubkey validation before relay queries (reuses PUBKEY_REGEX)
- No trust of unverified data
- Proper error propagation via `PeerDiscoveryError`

### Performance Considerations

No concerns. Implementation is efficient:
- Single batch query for follow list (O(1) relay round-trip)
- Event-driven subscription (no polling)
- Per-subscription `Map<string, number>` is lightweight (O(1) lookups)
- Timestamps tracked only for followed pubkeys (bounded memory)

### Files Modified During Review

None - implementation is complete and correct.

### Gate Status

Gate: PASS → docs/qa/gates/1.6-peer-update-subscriptions.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 0.2 | Validation fixes: merged Task 3/4, async signature, per-subscription state, empty follow tests | SM |
| 2026-02-06 | 1.0 | Implementation complete - all tasks done, 91 tests pass | Dev Agent |
| 2026-02-06 | 1.1 | QA Review: FAIL - TypeScript compilation error on line 190 | Quinn (QA) |
| 2026-02-06 | 1.2 | QA Fix: Changed `[filter]` to `filter` on line 190, lint/tests pass | Dev Agent |
