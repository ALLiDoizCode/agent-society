# Story 1.5: ILP Peer Info Discovery

## Status

Done

## Story

**As an** agent developer,
**I want** to discover ILP connection info for peers in my follow list,
**so that** I can configure peering relationships.

## Acceptance Criteria

1. `discoverPeers(pubkey: string): Promise<Map<string, IlpPeerInfo>>` method added to `NostrPeerDiscovery`
2. Method retrieves follow list, then queries kind:10032 events for each followed pubkey
3. Returns Map of pubkey → IlpPeerInfo for peers with published ILP info
4. Peers without kind:10032 events are silently excluded from results
5. Method completes within 5 seconds for 100 follows (mocked test)
6. Unit tests verify correct aggregation of follow list and peer info queries

## Tasks / Subtasks

- [x] Task 1: Add discoverPeers method signature (AC: 1)
  - [x] Add `discoverPeers(pubkey: string): Promise<Map<string, IlpPeerInfo>>` method to `NostrPeerDiscovery`
  - [x] Validate pubkey format (reuse existing validation)
  - [x] Import `IlpPeerInfo` type from types module
  - [x] Import `parseIlpPeerInfo` from events module

- [x] Task 2: Implement follow list retrieval step (AC: 2)
  - [x] Call existing `getFollows(pubkey)` method to get list of followed pubkeys
  - [x] Handle empty follow list case (return empty Map)

- [x] Task 3: Implement kind:10032 query for each followed pubkey (AC: 2, 3, 4)
  - [x] Create filter for kind:10032 with authors array containing all followed pubkeys
  - [x] Query using `pool.querySync(relayUrls, filter)`
  - [x] For each event returned, parse with `parseIlpPeerInfo()`
  - [x] Build Map of pubkey → IlpPeerInfo from successfully parsed events
  - [x] Silently skip events that fail to parse (AC: 4)
  - [x] Silently skip pubkeys with no kind:10032 event (AC: 4)

- [x] Task 4: Handle replaceable event semantics (AC: 3)
  - [x] When multiple kind:10032 events exist for same pubkey, use most recent (highest `created_at`)
  - [x] Group events by pubkey, sort each group by `created_at` descending, take first

- [x] Task 5: Update module exports (AC: 1)
  - [x] Verify `IlpPeerInfo` is already exported from package index (it is)
  - [x] No new exports needed - method is added to existing class

- [x] Task 6: Write unit tests for discoverPeers basic flow (AC: 1, 2, 6)
  - [x] Test discoverPeers returns Map with IlpPeerInfo for peers with kind:10032 events
  - [x] Test discoverPeers calls getFollows with provided pubkey
  - [x] Test discoverPeers queries kind:10032 for all followed pubkeys
  - [x] Test discoverPeers returns empty Map when follow list is empty

- [x] Task 7: Write unit tests for exclusion cases (AC: 4, 6)
  - [x] Test discoverPeers excludes peers without kind:10032 events
  - [x] Test discoverPeers excludes peers with malformed kind:10032 events
  - [x] Test discoverPeers continues when some events fail to parse (returns valid ones)

- [x] Task 8: Write unit tests for replaceable event handling (AC: 3, 6)
  - [x] Test discoverPeers uses most recent event when multiple exist for same pubkey
  - [x] Test discoverPeers handles events from multiple relays with different timestamps

- [x] Task 9: Write performance test (AC: 5)
  - [x] Test discoverPeers completes within 5 seconds for 100 follows (mocked)
  - [x] Mock querySync to return immediately with 100 events
  - [x] Use `vi.useFakeTimers()` and measure elapsed time

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.4.story.md#dev-agent-record]

- `NostrPeerDiscovery` class exists in `packages/core/src/discovery/NostrPeerDiscovery.ts`
- `getFollows(pubkey: string): Promise<string[]>` method is complete and tested
- `PeerDiscoveryError` exists in `packages/core/src/errors.ts` for error handling
- Uses `pool.querySync(relayUrls, filter)` pattern for querying relays
- Pubkey validation regex: `/^[0-9a-f]{64}$/`
- 64 tests currently pass in core package
- Package uses ESM (`"type": "module"`) - use `.js` extension in imports
- TypeScript strict mode is enabled

### Project Structure
[Source: docs/architecture/9-source-tree.md]

Files to modify for this story:
```
packages/core/src/
├── discovery/
│   ├── NostrPeerDiscovery.ts        # Add discoverPeers method (modify)
│   └── NostrPeerDiscovery.test.ts   # Add new tests (modify)
└── index.ts                         # No changes needed (IlpPeerInfo already exported)
```

### Data Models
[Source: docs/architecture/4-data-models.md]

**IlpPeerInfo (kind:10032):**
- `ilpAddress`: string - ILP address of the peer's connector
- `btpEndpoint`: string - BTP WebSocket endpoint URL
- `settlementEngine`: string | undefined - Settlement engine identifier
- `assetCode`: string - Asset code (e.g., "USD", "XRP")
- `assetScale`: number - Asset scale (decimal places)

**Nostr Event Tags:**
- kind:10032 events are replaceable (NIP-01) - only most recent per pubkey is canonical
- Event author pubkey identifies the peer

### Core Workflows
[Source: docs/architecture/7-core-workflows.md#peer-discovery-flow]

This story completes the peer discovery flow:
1. (Story 1.4) Agent calls `getFollows(myPubkey)` → Returns followed pubkeys
2. **This story:** For each followed pubkey → Query kind:10032 → Return Map<pubkey, IlpPeerInfo>

```
Agent → discoverPeers(myPubkey) → NostrPeerDiscovery
                                      ↓
                              getFollows(myPubkey)
                                      ↓
                              [pubkey1, pubkey2, ...]
                                      ↓
                        querySync(relays, {kinds: [10032], authors: [...]})
                                      ↓
                              Parse each event
                                      ↓
                        Map<pubkey, IlpPeerInfo>
```

### nostr-tools Usage
[Source: docs/architecture/3-tech-stack.md, docs/architecture/6-external-apis.md]

**Batch query for multiple authors:**
```typescript
import { SimplePool } from 'nostr-tools/pool';
import type { Filter } from 'nostr-tools/filter';
import { ILP_PEER_INFO_KIND } from '../constants.js';

const filter: Filter = {
  kinds: [ILP_PEER_INFO_KIND],
  authors: followedPubkeys,  // Array of pubkeys
};

// Returns events from all matching authors
const events = await pool.querySync(relayUrls, filter);
```

**Key insight:** Use a single query with all followed pubkeys as authors, not individual queries per pubkey. This is more efficient and avoids rate limiting.

### Event Parsing
[Source: packages/core/src/events/parsers.ts, docs/stories/1.3.story.md]

The `parseIlpPeerInfo` function is already implemented:
```typescript
import { parseIlpPeerInfo } from '../events/index.js';

try {
  const info = parseIlpPeerInfo(event);
  // Successfully parsed
} catch (error) {
  // InvalidEventError - skip this event
}
```

### Replaceable Event Handling
[Source: NIP-01, docs/architecture/4-data-models.md]

kind:10032 is a replaceable event (kind 10000-19999). When multiple events exist:
1. Group events by pubkey
2. For each group, use the event with highest `created_at`
3. Different relays may return different versions

```typescript
// Group events by pubkey, keep most recent for each
const eventsByPubkey = new Map<string, NostrEvent>();
for (const event of events) {
  const existing = eventsByPubkey.get(event.pubkey);
  if (!existing || event.created_at > existing.created_at) {
    eventsByPubkey.set(event.pubkey, event);
  }
}
```

### Error Handling
[Source: docs/architecture/11-error-handling-strategy.md]

**For this story:**
- Invalid pubkey → throw `PeerDiscoveryError` (reuse existing validation)
- Relay failures → `querySync` handles internally, continues with available relays
- Parse failures → Silently skip (AC: 4) - don't throw, just exclude from results
- Empty results → Return empty Map (not an error)

### Coding Standards
[Source: docs/architecture/12-coding-standards.md]

| Element | Convention | Example |
|---------|------------|---------|
| Method | camelCase | `discoverPeers` |
| Type | PascalCase | `IlpPeerInfo` |

**Critical Rules:**
- Never use `any` - use `unknown` and type guards
- Always mock SimplePool in tests - no live relay dependencies
- Use nostr-tools types - don't redefine event types

### Testing
[Source: docs/architecture/13-test-strategy-and-standards.md]

**Framework:** Vitest 1.x

**File:** `packages/core/src/discovery/NostrPeerDiscovery.test.ts` (add to existing)

**Mocking pattern (from Story 1.4):**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { NostrPeerDiscovery } from './NostrPeerDiscovery.js';
import type { SimplePool } from 'nostr-tools/pool';

const mockPool = {
  querySync: vi.fn(),
} as unknown as SimplePool;

// Mock return for discoverPeers test
vi.mocked(mockPool.querySync)
  .mockResolvedValueOnce([/* kind:3 events */])   // getFollows call
  .mockResolvedValueOnce([/* kind:10032 events */]); // discoverPeers call
```

**Test helper for kind:10032 events:**
```typescript
function createMockIlpPeerInfoEvent(pubkey: string, info: Partial<IlpPeerInfo> = {}) {
  return {
    kind: 10032,
    pubkey,
    content: JSON.stringify({
      ilpAddress: info.ilpAddress ?? 'g.test.peer',
      btpEndpoint: info.btpEndpoint ?? 'wss://btp.test',
      assetCode: info.assetCode ?? 'USD',
      assetScale: info.assetScale ?? 6,
      ...info,
    }),
    created_at: Math.floor(Date.now() / 1000),
    tags: [],
    id: 'mock-id',
    sig: 'mock-sig',
  };
}
```

**Performance test pattern:**
```typescript
it('completes within 5 seconds for 100 follows', async () => {
  vi.useFakeTimers();

  // Mock 100 follows
  const follows = Array.from({ length: 100 }, (_, i) => 'a'.repeat(64).replace(/a/g, String(i % 10)));
  vi.mocked(mockPool.querySync)
    .mockResolvedValueOnce([/* kind:3 with 100 follows */])
    .mockResolvedValueOnce([/* 100 kind:10032 events */]);

  const start = Date.now();
  await discovery.discoverPeers(pubkey);
  const elapsed = Date.now() - start;

  expect(elapsed).toBeLessThan(5000);
  vi.useRealTimers();
});
```

**Test Requirements:**
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all SimplePool calls
- Test both success and exclusion paths
- Cover replaceable event semantics
- >80% coverage for new method

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List
| File | Action |
|------|--------|
| `packages/core/src/discovery/NostrPeerDiscovery.ts` | Modified - added `discoverPeers` method |
| `packages/core/src/discovery/NostrPeerDiscovery.test.ts` | Modified - added 11 new tests for `discoverPeers` |

### Completion Notes
- Implemented `discoverPeers(pubkey: string): Promise<Map<string, IlpPeerInfo>>` method
- Uses single batch query for all followed pubkeys (efficient relay usage)
- Handles replaceable event semantics (uses most recent event per pubkey)
- Silently excludes peers without kind:10032 events or with malformed events
- All 75 tests pass (11 new tests added for this story)
- Linting passes, build succeeds
- Performance test uses `performance.now()` instead of fake timers (more reliable for mocked async)

**QA Fixes Applied (2026-02-06):**
- Fixed TypeScript TS2352 error in test file (TS-001 from gate)
- Changed 4 direct `as VerifiedEvent` casts to `as unknown as VerifiedEvent` in test helpers
- Locations fixed: lines 22, 45, 429, 466 of NostrPeerDiscovery.test.ts
- All 3 TypeScript errors resolved, tests continue passing

### Debug Log References
**QA Fixes (2026-02-06):**
- TypeScript check: `pnpm tsc --noEmit` - 0 errors after fix
- Lint: `pnpm -w run lint` - 0 problems
- Tests: `pnpm -w run test` - 75 tests pass (6 test files)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 0.1 | Initial story draft | SM |
| 2026-02-06 | 1.0 | Implementation complete - discoverPeers method with tests | Dev Agent |
| 2026-02-06 | 1.1 | QA fixes - fixed VerifiedEvent type casting in test helpers (TS-001) | Dev Agent |

---

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Good implementation with minor TypeScript strictness issue in tests**

The `discoverPeers` method implementation is clean, efficient, and follows established patterns from the codebase. Key strengths:

1. **Efficient batch querying**: Uses single `querySync` call with all followed pubkeys as authors rather than N individual calls - follows relay best practices
2. **Correct replaceable event handling**: Properly groups by pubkey and selects most recent by `created_at`
3. **Silent exclusion**: Gracefully handles missing/malformed events per AC#4 without throwing
4. **Consistent error handling**: Reuses existing pubkey validation and error patterns from `getFollows`
5. **Type safety**: Proper use of `IlpPeerInfo` type throughout

### Refactoring Performed

None - implementation quality is solid. TypeScript issue in tests noted below requires dev attention.

### Compliance Check

- Coding Standards: ✓ All naming conventions followed (camelCase methods, PascalCase types)
- Project Structure: ✓ Files in correct locations, proper exports
- Testing Strategy: ✓ 11 new unit tests, AAA pattern, all SimplePool mocked
- All ACs Met: ✓ All 6 acceptance criteria verified

### Improvements Checklist

- [x] Implementation uses batch query pattern (efficient)
- [x] Replaceable event semantics correctly implemented
- [x] Silent exclusion of missing/malformed peers
- [x] Performance test included (100 follows in <5s)
- [x] **Fix TypeScript error in test file** - Test helper `createIlpPeerInfoEvent` casts to `VerifiedEvent` but is missing `[verifiedSymbol]` property. Need to cast through `unknown` first or use `NostrEvent` instead. Affects lines 31, 421, 458. **FIXED: Cast through `unknown` first.**

### Security Review

No security concerns identified. The implementation:
- Validates pubkey format before processing
- Uses established parsing with validation from `parseIlpPeerInfo`
- Does not trust unverified data (though note: `querySync` returns events without signature verification; this is documented project behavior per coding standards)

### Performance Considerations

- Single batch query pattern is efficient for relay usage
- Map-based grouping for replaceable events is O(n)
- Performance test confirms <5s for 100 follows (mocked) - passes AC#5

### Files Modified During Review

None - no refactoring performed.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.5-ilp-peer-info-discovery.yml

### Recommended Status

✗ Changes Required - TypeScript compilation fails with 3 type errors in test file. See unchecked item above.

**Note to Dev**: Fix the `VerifiedEvent` type assertion in `createIlpPeerInfoEvent` helper:
```typescript
// Current (fails TypeScript strict mode):
} as VerifiedEvent;

// Fix option 1 - cast through unknown:
} as unknown as VerifiedEvent;

// Fix option 2 - use NostrEvent type instead:
import type { NostrEvent } from 'nostr-tools/pure';
// Then use NostrEvent in return type
```

(Story owner decides final status)
